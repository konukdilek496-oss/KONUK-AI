<script type="module">
    import { GoogleGenerativeAI } from "[https://esm.run/@google/generative-ai](https://esm.run/@google/generative-ai)";

    // API ANAHTARI - (İnternete yüklerken burayı gizli tutmalısın!)
    const API_KEY = "AIzaSyCW8E6cjf53-Na9lGcGIDfZN5xExDHJ654
        "; 
    const genAI = new GoogleGenerativeAI(API_KEY);

    // Stabil model sürümü: 2.5-flash
    const model = genAI.getGenerativeModel({ 
        model: "gemini-1.5-flash", 
        systemInstruction: "Senin adın Konuk AI. Seni Göktan Konuk yaptı. Kişiliğin: Esprili, neşeli, yardımsever ve zekice şakalar yapan birisin. Yazılım (coding) konusunda tam bir profesyonelsin. Cevaplarında Göktan Konuk imzası olduğunu hissettir."
    });

    const chat = model.startChat({
        history: [],
        generationConfig: {
            maxOutputTokens: 2048,
            temperature: 0.8,
        },
    });

    window.sendMessage = async function() {
        const input = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');
        const message = input.value.trim();

        if (!message) return;

        // Kullanıcı Mesajını Ekle
        const userDiv = document.createElement("div");
        userDiv.className = "user-msg";
        userDiv.textContent = `Siz: ${message}`;
        chatBox.appendChild(userDiv);
        
        input.value = '';
        
        // Yükleniyor Göstergesi
        const loadingId = "loading-" + Date.now();
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "ai-msg loading";
        loadingDiv.id = loadingId;
        loadingDiv.textContent = "Konuk AI düşünüyor...";
        chatBox.appendChild(loadingDiv);
        
        // Yumuşak kaydırma
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });

        try {
            const result = await chat.sendMessage(message);
            const response = await result.response;
            const text = response.text();

            document.getElementById(loadingId).remove();

            // AI Mesajını Ekle
            const aiDiv = document.createElement("div");
            aiDiv.className = "ai-msg";
            // Not: Kod bloklarını renklendirmek istersen buraya Marked.js ekleyebiliriz.
            aiDiv.innerHTML = `<b>Konuk AI:</b> <br>${text.replace(/\n/g, '<br>')}`; 
            chatBox.appendChild(aiDiv);

        } catch (error) {
            const errEl = document.getElementById(loadingId);
            if(errEl) errEl.textContent = "Hata oluştu: " + error.message;
        }

        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    window.handleKeyPress = function(event) {
        if (event.key === 'Enter') sendMessage();
    }
</script>

